# ميزات الجلسات الاشتراكية - branchHUB Dashboard

## نظرة عامة

تم إضافة ميزات متقدمة للجلسات الاشتراكية في النظام، مما يتيح إدارة أفضل للاشتراكات طويلة المدى.

## الميزات الجديدة

### 1. تحديد تاريخ انتهاء الجلسة

#### الوظائف المضافة:
- **حقل `expected_end_date`**: حقل جديد في قاعدة البيانات لتخزين التاريخ المتوقع لانتهاء الجلسة
- **تحديث التاريخ المتوقع**: إمكانية تحديد تاريخ انتهاء مخصص للجلسات الاشتراكية
- **التحقق من صحة التاريخ**: التأكد من أن تاريخ الانتهاء بعد تاريخ البداية

#### كيفية الاستخدام:
1. انتقل إلى صفحة تفاصيل الجلسة الاشتراكية
2. اضغط على زر "تحديث تاريخ الانتهاء"
3. اختر التاريخ والوقت المطلوب
4. اضغط "حفظ التغييرات"

### 2. إنهاء الجلسة يدوياً

#### الوظائف المضافة:
- **إنهاء فوري**: إمكانية إنهاء الجلسة الاشتراكية في أي وقت
- **تحديد وقت الانتهاء**: إمكانية تحديد وقت انتهاء مخصص
- **تسجيل التدقيق**: تسجيل جميع عمليات الإنهاء في سجل التدقيق

#### كيفية الاستخدام:
1. انتقل إلى صفحة تفاصيل الجلسة الاشتراكية
2. اضغط على زر "إنهاء الجلسة"
3. اختر وقت الانتهاء (اختياري)
4. اضغط "إنهاء الجلسة"

## التحسينات في الواجهة

### 1. صفحة تفاصيل الجلسة
- **أزرار خاصة للجلسات الاشتراكية**: أزرار منفصلة لتحديث التاريخ وإنهاء الجلسة
- **معلومات إضافية**: عرض الأيام المتبقية وحالة الجلسة
- **نوافذ منبثقة**: نوافذ مخصصة لإدارة الجلسات الاشتراكية

### 2. صفحة قائمة الجلسات
- **عمود معلومات إضافية**: عرض حالة الجلسات الاشتراكية والأيام المتبقية
- **فلترة متقدمة**: فلترة خاصة للجلسات الاشتراكية النشطة
- **إحصائيات إضافية**: إحصائيات للاشتراكات النشطة والمتأخرة

### 3. لوحة التحكم
- **إحصائيات الجلسات الاشتراكية**: عرض عدد الاشتراكات النشطة والمتأخرة
- **أزرار سريعة**: وصول سريع للجلسات الاشتراكية
- **تنبيهات**: عرض الجلسات المتأخرة في الجلسات الحديثة

## الوظائف التقنية

### النموذج (Session Model)

#### الدوال الجديدة:
```php
// تحديث التاريخ المتوقع للانتهاء
public function updateExpectedEndDate($expectedEndDate)

// إنهاء الجلسة يدوياً
public function endSessionManually($endTime = null)

// التحقق من كون الجلسة من نوع اشتراك
public function isSubscription()

// الحصول على الأيام المتبقية
public function getRemainingDays()
```

### التحكم (SessionController)

#### الدوال الجديدة:
```php
// تحديث التاريخ المتوقع للانتهاء
public function updateExpectedEndDate(Request $request, Session $session)

// إنهاء الجلسة الاشتراكية
public function endSubscriptionSession(Request $request, Session $session)
```

### المسارات الجديدة:
```php
// تحديث التاريخ المتوقع للانتهاء
PUT /sessions/{session}/update-expected-end-date

// إنهاء الجلسة الاشتراكية
POST /sessions/{session}/end-subscription
```

## قاعدة البيانات

### التغييرات:
- **جدول `user_sessions`**: إضافة حقل `expected_end_date` (timestamp, nullable)

### Migration:
```php
// 2025_08_30_035609_add_expected_end_date_to_sessions_table.php
Schema::table('user_sessions', function (Blueprint $table) {
    $table->timestamp('expected_end_date')->nullable()->after('end_at');
});
```

## الميزات الأمنية

### التحقق من الصلاحيات:
- التحقق من أن الجلسة من نوع اشتراك
- التحقق من أن الجلسة نشطة
- التحقق من صحة التواريخ المدخلة

### تسجيل التدقيق:
- تسجيل جميع عمليات تحديث التاريخ المتوقع
- تسجيل جميع عمليات إنهاء الجلسة
- حفظ القيم القديمة والجديدة

## الاستخدام الأمثل

### للجلسات الاشتراكية الجديدة:
1. إنشاء جلسة اشتراكية جديدة
2. تحديد تاريخ انتهاء مخصص إذا لزم الأمر
3. مراقبة حالة الجلسة من لوحة التحكم

### للجلسات الاشتراكية الحالية:
1. مراجعة الجلسات المتأخرة
2. تحديث تواريخ الانتهاء حسب الحاجة
3. إنهاء الجلسات المنتهية

## الدعم والمساعدة

### في حالة المشاكل:
1. تحقق من سجلات التدقيق
2. راجع حالة الجلسة في قاعدة البيانات
3. تأكد من صحة التواريخ المدخلة

### للمطورين:
- جميع الدوال الجديدة موثقة في الكود
- يمكن تخصيص الميزات حسب الحاجة
- النظام قابل للتوسع لإضافة ميزات جديدة

## الخلاصة

تم إضافة نظام متكامل لإدارة الجلسات الاشتراكية يتيح:
- تحديد تواريخ انتهاء مخصصة
- إنهاء الجلسات في أي وقت
- مراقبة حالة الجلسات بسهولة
- إحصائيات مفصلة للاشتراكات

هذه الميزات تجعل إدارة الجلسات الاشتراكية أكثر مرونة وكفاءة. 